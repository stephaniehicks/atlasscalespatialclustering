---
title: "SpatialLIBD_try"
author: "Anonymous"
date: "2023-06-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("~/GitHub/atlasscalespatialclustering/haowen_update/R/func.R")



my_fetch_data <- function (type = c("sce", "sce_layer", "modeling_results", "sce_example", 
                                    "spe", "spatialDLPFC_Visium", "spatialDLPFC_Visium_pseudobulk", 
                                    "spatialDLPFC_Visium_modeling_results", "spatialDLPFC_Visium_SPG", 
                                    "spatialDLPFC_snRNAseq", "Visium_SPG_AD_Visium_wholegenome_spe", 
                                    "Visium_SPG_AD_Visium_targeted_spe", "Visium_SPG_AD_Visium_wholegenome_pseudobulk_spe", 
                                    "Visium_SPG_AD_Visium_wholegenome_modeling_results"), destdir = tempdir(), 
                           eh = ExperimentHub::ExperimentHub(), bfc = BiocFileCache::BiocFileCache()) 
{
  sce <- sce_layer <- modeling_results <- sce_sub <- spe <- NULL
  type <- match.arg(type)
  stopifnot(methods::is(eh, "ExperimentHub"))
  if (type == "spe") {
    spe <- sce_to_spe(fetch_data("sce", destdir = destdir, 
                                 eh = eh))
    return(spe)
  }
  if (type == "sce") {
    if (!T) {
      warning(paste("Your system might not have enough memory available.", 
                    "Try with a machine that has more memory", "or use the 'sce_example'."))
    }
    tag <- "Human_Pilot_DLPFC_Visium_spatialLIBD"
    hub_title <- "Human_Pilot_DLPFC_Visium_spatialLIBD_spot_level_SCE"
    file_name <- "Human_DLPFC_Visium_processedData_sce_scran_spatialLIBD.Rdata"
    url <- "https://www.dropbox.com/s/f4wcvtdq428y73p/Human_DLPFC_Visium_processedData_sce_scran_spatialLIBD.Rdata?dl=1"
  }
  else if (type == "sce_layer") {
    tag <- "Human_Pilot_DLPFC_Visium_spatialLIBD"
    hub_title <- "Human_Pilot_DLPFC_Visium_spatialLIBD_layer_level_SCE"
    file_name <- "Human_DLPFC_Visium_processedData_sce_scran_sce_layer_spatialLIBD.Rdata"
    url <- "https://www.dropbox.com/s/bg8xwysh2vnjwvg/Human_DLPFC_Visium_processedData_sce_scran_sce_layer_spatialLIBD.Rdata?dl=1"
  }
  else if (type == "modeling_results") {
    tag <- "Human_Pilot_DLPFC_Visium_spatialLIBD"
    hub_title <- "Human_Pilot_DLPFC_Visium_spatialLIBD_modeling_results"
    file_name <- "Human_DLPFC_Visium_modeling_results.Rdata"
    url <- "https://www.dropbox.com/s/se6rrgb9yhm5gfh/Human_DLPFC_Visium_modeling_results.Rdata?dl=1"
  }
  else if (type == "sce_example") {
    tag <- "Human_Pilot_DLPFC_Visium_spatialLIBD"
    hub_title <- "Human_DLPFC_Visium_sce_example"
    file_name <- "sce_sub_for_vignette.Rdata"
    url <- "https://www.dropbox.com/s/5ra9o8ku9iyyf70/sce_sub_for_vignette.Rdata?dl=1"
  }
  else if (type == "spatialDLPFC_Visium") {
    if (!T) {
      warning(paste("Your system might not have enough memory available (7GB).", 
                    "Try with a machine that has more memory."))
    }
    tag <- "spatialDLPFC_Visium_VisiumSPG_snRNAseq_spatialLIBD"
    hub_title <- "spatialDLPFC_Visium_spe"
    file_name <- "spe_filtered_final_with_clusters_and_deconvolution_results.rds"
    url <- "https://www.dropbox.com/s/y2ifv5v8g68papf/spe_filtered_final_with_clusters_and_deconvolution_results.rds?dl=1"
  }
  else if (type == "spatialDLPFC_Visium_pseudobulk") {
    tag <- "spatialDLPFC_Visium_VisiumSPG_snRNAseq_spatialLIBD"
    hub_title <- "spatialDLPFC_Visium_pseudobulk_spe"
    file_name <- "sce_pseudo_BayesSpace_k09.rds"
    url <- "https://www.dropbox.com/s/pbti4strsfk1m55/sce_pseudo_BayesSpace_k09.rds?dl=1"
  }
  else if (type == "spatialDLPFC_Visium_modeling_results") {
    tag <- "spatialDLPFC_Visium_VisiumSPG_snRNAseq_spatialLIBD"
    hub_title <- type
    file_name <- "modeling_results_BayesSpace_k09.Rdata"
    url <- "https://www.dropbox.com/s/srkb2ife75px2yz/modeling_results_BayesSpace_k09.Rdata?dl=1"
  }
  else if (type == "spatialDLPFC_Visium_SPG") {
    tag <- "spatialDLPFC_Visium_VisiumSPG_snRNAseq_spatialLIBD"
    hub_title <- "spatialDLPFC_Visium_SPG_spe"
    file_name <- "spe.rds"
    url <- "https://www.dropbox.com/s/nbf13dna9ibqfaa/spe.rds?dl=1"
  }
  else if (type == "spatialDLPFC_snRNAseq") {
    tag <- "spatialDLPFC_Visium_VisiumSPG_snRNAseq_spatialLIBD"
    hub_title <- type
    file_name <- "sce_DLPFC_annotated.zip"
    url <- "https://www.dropbox.com/s/5919zt00vm1ht8e/sce_DLPFC_annotated.zip?dl=1"
  }
  else if (type == "Visium_SPG_AD_Visium_wholegenome_spe") {
    tag <- "Visium_SPG_AD_Alzheimer_Disease_ITC_spatialLIBD"
    hub_title <- type
    file_name <- "Visium_SPG_AD_spe_wholegenome.Rdata"
    url <- "https://www.dropbox.com/s/ng036m63grykdm6/Visium_SPG_AD_spe_wholegenome.Rdata?dl=1"
  }
  else if (type == "Visium_SPG_AD_Visium_targeted_spe") {
    tag <- "Visium_SPG_AD_Alzheimer_Disease_ITC_spatialLIBD"
    hub_title <- type
    file_name <- "Visium_SPG_AD_spe_targeted.Rdata"
    url <- "https://www.dropbox.com/s/kda9160awc2h8jq/Visium_SPG_AD_spe_targeted.Rdata?dl=1"
  }
  else if (type == "Visium_SPG_AD_Visium_wholegenome_pseudobulk_spe") {
    tag <- "Visium_SPG_AD_Alzheimer_Disease_ITC_spatialLIBD"
    hub_title <- type
    file_name <- "sce_pseudo_pathology_wholegenome.rds"
    url <- "https://www.dropbox.com/s/p8foxj6t6inb8uf/sce_pseudo_pathology_wholegenome.rds?dl=1"
  }
  else if (type == "Visium_SPG_AD_Visium_wholegenome_modeling_results") {
    tag <- "Visium_SPG_AD_Alzheimer_Disease_ITC_spatialLIBD"
    hub_title <- type
    file_name <- "Visium_IF_AD_modeling_results.Rdata"
    url <- "https://www.dropbox.com/s/5plupu8bj5m0kfh/Visium_IF_AD_modeling_results.Rdata?dl=1"
  }
  file_path <- file.path(destdir, file_name)
  if (!file.exists(file_path)) {
    q <- AnnotationHub::query(eh, pattern = c(tag, hub_title))
    if (length(q) == 1) {
      res <- q[[1]]
      if (type %in% c("sce", "sce_example")) {
        res <- .update_sce(res)
      }
      else if (type == "sce_layer") {
        res <- .update_sce_layer(res)
      }
      return(res)
    }
    else {
      file_path <- BiocFileCache::bfcrpath(bfc, url)
    }
  }
  message(Sys.time(), " loading file ", file_path)
  if (grepl(".Rdata", file_path)) {
    load(file_path, verbose = FALSE)
    if (type == "sce") {
      return(spatialLIBD:::.update_sce(sce))
    }
    else if (type == "sce_layer") {
      return(spatialLIBD:::.update_sce_layer(sce_layer))
    }
    else if (type == "modeling_results" || type == "spatialDLPFC_Visium_modeling_results" || 
             type == "Visium_SPG_AD_Visium_wholegenome_modeling_results") {
      return(modeling_results)
    }
    else if (type == "sce_example") {
      return(spatialLIBD:::.update_sce(sce_sub))
    }
    else if (type == "Visium_SPG_AD_Visium_wholegenome_spe" || 
             type == "Visium_SPG_AD_Visium_targeted_spe") {
      return(spe)
    }
  }
  else if (grepl(".rds", file_path)) {
    return(readRDS(file_path))
  }
  else {
    file_path
  }
}
```

## Download Data


```{r load_data}
## Connect to ExperimentHub
ehub <- ExperimentHub::ExperimentHub()
## Download the small example sce data
#spe <- my_fetch_data(type = "sce", eh = ehub, destdir = "E:/share_hdd/research/sce/") %>% sce_to_spe()

spe <- fetch_data(type = "spe", eh = ehub, destdir = "E:/share_hdd/research/sce/")

sp_obj_ls <- readRDS("~/RScripts/SpotCleaned_obj_ls2.RDS")
```
Ground Truth

```{r}
vis_grid_clus(
    spe = spe,
    pdf_file = "Jun19_ground_truth.pdf",
    clustervar = "layer_guess_reordered_short",
    sample_order = unique(spe$sample_id),
    ... = " LIBD Layers"
)

vis_gene(spe, "151676", geneid = "GNG11; ENSG00000127920")

```
# Create Seurat List

## From SpotClean Result

```{r}
sets_tokeep <- c('151507','151508','151509','151510','151669','151670','151671','151672','151673','151674','151675','151676')


```


# PRECAST Results

```{r}

##### Para Select #####
#getXList <- function(seuList, genelist){
#  require(Seurat)
#  set.seed(101)
#  seuList <- lapply(seuList, NormalizeData)
#  XList <- list()
#  nsample <- length(seuList)
#  indexList <- list()
#  nr <- 0
#  yList <- list()
#  posList <- list()
#  for(i in 1:nsample){
#    XList[[i]] <- Matrix::t(seuList[[i]]@assays$RNA@data[genelist,])
#    indexList[[i]] <- (nr+1):(nrow(XList[[i]] )+nr)
#    nr <- nr + nrow(XList[[i]] )
#    y <- seuList[[i]]$layer
#    y[is.na(y)] <- "NA"
#    yList[[i]] <- y
#    posList[[i]] <- cbind(seuList[[i]]$row, seuList[[i]]$col)
#  }
#  
#  return(list(XList=XList, posList=posList, 
#              yList=yList, 
#              indxList=indexList))
#}
#
#datList <- getXList(seurat_ls, hvg_ls)
#XList <- datList$XList
#posList <- datList$posList
#yList <- datList$yList 
#indexList <- datList$indxList
#
#K_set <- 2:11; q <- 15
#tic <- proc.time() # 
#set.seed(1) ## parallel computing
#resList <- ICM.EM(XList, posList=posList, q=q, K=K_set, 
#                 platform = 'Visium',maxIter = 30,
#                 Sigma_equal =F, verbose=T,  coreNum=4, coreNum_int = 4)
#toc <- proc.time()
#
##### One K #####



```


## Run


```{r}
cl_df_ls <- list()

##### Try 2LC #####
seurat_ls <- new_seu_ls()
ari_df <- data.frame(ID = names(seurat_ls),
                     nn_6 = 0,
                     nn_12 = 0,
                     nn_18 = 0,
                     sp_nn_6 = 0,
                     sp_nn_12 = 0,
                     sp_nn_18 = 0,
                     PRECAST_6 = 0,
                     PRECAST_7 = 0,
                     PRECAST_8 = 0,
                     PRECAST_log_6 = 0,
                     PRECAST_log_7 = 0,
                     PRECAST_log_8 = 0,
                     row.names = names(seurat_ls))

for(k in c(6,12,18)){
  message("Running K=",k)
  seurat_ls <- stage_1(seurat_ls,nn = k)
  cl_df_ls[[paste0("nn_",k)]] <- stage_2(seurat_ls)
  seurat_ls <- assign_label(seurat_ls,cl_df_ls[[paste0("nn_",k)]],k)
  gc()
}


##### Try PRECAST logcount #####
for(k in c(6,7,8)){
  message("Running K=",k)
  seuInt <- PRECAST_test(seurat_ls,k=k)
  gc()
  for(i in seq_along(names(seurat_ls))){
    tmp_df <- data.frame(barcode = row.names(seuInt@meta.data) %>% 
                           str_sub(start = 1, end = 18))
    tmp_df[[paste0("PRECAST_",k)]] <- seuInt@meta.data[["cluster"]]
    tmp_df <- left_join(seurat_ls[[names(seurat_ls)[i]]]@meta.data, 
                        tmp_df[seuInt@meta.data[["batch"]]==i,], by="barcode")
    seurat_ls[[names(seurat_ls)[i]]]@meta.data[[paste0("PRECAST_",k)]] <- tmp_df[[paste0("PRECAST_",k)]]
  }
}
#### Calc ARI and rm
combined_meta <- NULL
for(i in names(seurat_ls)){
  if(is.null(combined_meta)){
    combined_meta <- data.frame(ID = i,
                                seurat_ls[[i]]@meta.data)
  }else{
    combined_meta <- rbind(combined_meta,
                              data.frame(ID = i,seurat_ls[[i]]@meta.data))
  }
  for(k in c(6,12,18)){
    ari_df[i,paste0("nn_",k)] <- mclust::adjustedRandIndex(combined_meta[[paste0("sec_cluster_",k)]][combined_meta$ID==i],
                                               combined_meta$layer[combined_meta$ID==i])
  }
  for(k in c(6,7,8)){
    ari_df[i,paste0("PRECAST_log_",k)] <- mclust::adjustedRandIndex(combined_meta[[paste0("PRECAST_",k)]][combined_meta$ID==i],
                                            combined_meta$layer[combined_meta$ID==i])
  }
}
##### Try PRECAST count #####
rm(seurat_ls)
gc()
seurat_ls <- new_seu_ls(sel_assay = "counts")
for(k in c(6,7,8)){
  message("Running K=",k)
  seuInt <- PRECAST_test(seurat_ls,k=k)
  gc()
  for(i in seq_along(names(seurat_ls))){
    tmp_df <- data.frame(barcode = row.names(seuInt@meta.data) %>% 
                           str_sub(start = 1, end = 18))
    tmp_df[[paste0("PRECAST_",k)]] <- seuInt@meta.data[["cluster"]]
    tmp_df <- left_join(seurat_ls[[names(seurat_ls)[i]]]@meta.data, 
                        tmp_df[seuInt@meta.data[["batch"]]==i,], by="barcode")
    seurat_ls[[names(seurat_ls)[i]]]@meta.data[[paste0("PRECAST_",k)]] <- tmp_df[[paste0("PRECAST_",k)]]
  }
}
# Update ARI
combined_meta_bk <- combined_meta 
combined_meta <- NULL
for(i in names(seurat_ls)){
  if(is.null(combined_meta)){
    combined_meta <- data.frame(ID = i,
                                seurat_ls[[i]]@meta.data)
  }else{
    combined_meta <- rbind(combined_meta,
                              data.frame(ID = i,seurat_ls[[i]]@meta.data))
  }

  for(k in c(6,7,8)){
    ari_df[i,paste0("PRECAST_",k)] <- mclust::adjustedRandIndex(combined_meta[[paste0("PRECAST_",k)]][combined_meta$ID==i],
                                            combined_meta$layer[combined_meta$ID==i])
  }
}

##### Try 2LC w/ SpotClean #####
rm(seurat_ls)
gc()
spseurat_ls <- new_spseu_ls()
plot_ls <- list()
for(k in c(6,12,18)){
  spseurat_ls <- stage_1(spseurat_ls,nn = k)
  cl_df_ls[[paste0("sp_nn_",k)]] <- stage_2(spseurat_ls)
  spseurat_ls <- assign_label(spseurat_ls,cl_df_ls[[paste0("sp_nn_",k)]],k)
  for(i in sets_tokeep){
    plot_ls[[paste0("sp",i,"_nn_",k)]] <- spseurat_ls[[i]]@misc[["graph_plot_cluster_secondary"]]
  }
  
}

ggarrange(plotlist = plot_ls[1:12], nrow = 3, ncol = 4)

combined_meta <- NULL
for(i in names(spseurat_ls)){
  if(is.null(combined_meta)){
    combined_meta <- data.frame(ID = i,
                                spseurat_ls[[i]]@meta.data
                                )
  }else{
    combined_meta <- rbind(combined_meta,
                              data.frame(ID = i,spseurat_ls[[i]]@meta.data
                                         ))
  }

  for(k in c(6,12,18)){
    ari_df[i,paste0("sp_nn_",k)] <- mclust::adjustedRandIndex(as.numeric(combined_meta[[paste0("sec_cluster_",k)]][combined_meta$ID==i]),
                                               combined_meta$layer[combined_meta$ID==i])
  }
}

library(reshape2)
ggplot(ari_df %>% melt(id.vars='ID') %>% 
         subset(ID %in% sets_tokeep | !(variable %in% c("sp_nn_6","sp_nn_12","sp_nn_18"))), 
       aes(x = variable,y=value, fill=variable)) + 
  geom_boxplot(color="black", width=0.5) + 
  geom_point() + 
  ylab("ARI") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))


ggplot(cl_df,aes(x=umap_1,y=umap_2, color=louvain)) + 
  geom_point()+
  theme_classic()

ggplot(cl_df,aes(x=umap_1,y=umap_2, color=layer)) + 
  geom_point()+
  theme_classic()

ggplot(cl_df,aes(x=umap_1,y=umap_2, color=sample)) + 
  geom_point()+
  theme_classic()


plot_ls <- list()
for(i in unique(spe$sample_id)){
  plot_ls[[i]] <-  seurat_ls[[i]]@misc[["graph_plot_cluster_secondary"]] 
}

ggarrange(plotlist = plot_ls, nrow = 3, ncol = 4)

plot_ls <- list()
for(i in unique(spe$sample_id)){
  plot_ls[[i]] <-  seurat_ls[[i]]@misc[["raw_graph_plot_label"]] 
}

ggarrange(plotlist = plot_ls, nrow = 3, ncol = 4)

```

```{r }
combined_meta <- NULL

for(i in names(seurat_ls)){
  if(is.null(combined_meta)){
    combined_meta <- seurat_ls[[i]]@meta.data
  }else{
    combined_meta <- rbind(combined_meta,seurat_ls[[i]]@meta.data)
  }
}

summ_combined_meta <- combined_meta %>% group_by(orig.ident, cluster) %>% summarise(n=n())

ggplot(summ_combined_meta, aes(x = orig.ident, y = n, fill = orig.ident)) + 
  geom_violin() + 
  geom_boxplot(width=0.1, fill="white") +
  labs(title = "Spot # before merging") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=45,vjust = 0.5)) 

summ_combined_meta <- combined_meta %>% group_by(orig.ident, merged_cluster) %>% summarise(n=n())

ggplot(summ_combined_meta, aes(x = orig.ident, y = n, fill = orig.ident)) + 
  geom_violin() + 
  geom_boxplot(width=0.1, fill="white") +
  labs(title = "Spot # after merging") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=45,vjust = 0.5)) 


```



### ARI Benchmark

```{r }
combined_meta <- NULL

ari_df <- data.frame(ID = sets_tokeep,
                     nn_6 = 0,
                     nn_12 = 0,
                     nn_18 = 0,
                     PRECAST = 0,
                     row.names = sets_tokeep)

for(i in sets_tokeep){
  if(is.null(combined_meta)){
    combined_meta <- data.frame(ID = i,
                                seurat_ls[[i]]@meta.data#,
                                #PRECAST = seuInt@meta.data[["cluster"]][seuInt@meta.data[["batch"]]==which(sample_vec==i)]
                                )
  }else{
    if(i=="151510"){
      combined_meta <- rbind(combined_meta,
                              data.frame(ID = i,seurat_ls[[i]]@meta.data))#[-567,],
                                         #PRECAST = seuInt@meta.data[["cluster"]][seuInt@meta.data[["batch"]]==which(sample_vec==i)])
    }else{
      combined_meta <- rbind(combined_meta,
                              data.frame(ID = i,seurat_ls[[i]]@meta.data))
                                         #PRECAST = seuInt@meta.data[["cluster"]][seuInt@meta.data[["batch"]]==which(sample_vec==i)]))
    }
    
  }
#  ari_df[i,"nn_6"] <- mclust::adjustedRandIndex(combined_meta$sec_cluster_6[combined_meta$ID==i],
#                                              combined_meta$layer[combined_meta$ID==i])
  ari_df[i,"nn_12"] <- mclust::adjustedRandIndex(combined_meta$sec_cluster_12[combined_meta$ID==i],
                                              combined_meta$layer[combined_meta$ID==i])
#  ari_df[i,"nn_18"] <- mclust::adjustedRandIndex(combined_meta$sec_cluster_18[combined_meta$ID==i],
#                                              combined_meta$layer[combined_meta$ID==i])
#  ari_df[i,"PRECAST"] <- mclust::adjustedRandIndex(combined_meta$PRECAST[combined_meta$ID==i],
#                                              combined_meta$layer[combined_meta$ID==i])
}





plot_ls <- list()

plot_ls[[1]] <- plotConfusionMatrix(combined_meta$sec_cluster_6,
                                    combined_meta$layer,"NN=6")
plot_ls[[2]] <- plotConfusionMatrix(combined_meta$sec_cluster_12,
                                    combined_meta$layer,"NN=12")
plot_ls[[3]] <- plotConfusionMatrix(combined_meta$sec_cluster_18,
                                    combined_meta$layer,"NN=18")
plot_ls[[4]] <- plotConfusionMatrix(combined_meta$PRECAST,
                                    combined_meta$layer,"PRECAST")

plot_ls[[5]] <- plotConfusionMatrix(combined_meta$sec_cluster_6,
                                    combined_meta$ID,"NN=6")
plot_ls[[6]] <- plotConfusionMatrix(combined_meta$sec_cluster_12,
                                    combined_meta$ID,"NN=12")
plot_ls[[7]] <- plotConfusionMatrix(combined_meta$sec_cluster_18,
                                    combined_meta$ID,"NN=18")
plot_ls[[8]] <- plotConfusionMatrix(combined_meta$PRECAST,
                                    combined_meta$ID,"PRECAST")

plot_ls[[1]] + plot_ls[[2]] + plot_ls[[3]] + plot_ls[[4]]



wilcox.test(ari_df$nn_12,ari_df$PRECAST)

```



